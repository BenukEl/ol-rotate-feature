/*!
OpenLayers 3 rotate interaction.
Allows vector feature rotation.

@package ol3-rotate-feature
@author Vladimir Vershinin <ghettovoice@gmail.com>
@version 1.0.0
@licence MIT https://opensource.org/licenses/MIT
         Based on OpenLayers 3. Copyright 2005-2015 OpenLayers Contributors. All rights reserved. http://openlayers.org
@copyright (c) 2016, Vladimir Vershinin <ghettovoice@gmail.com>
*/
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("ol")):"function"==typeof define&&define.amd?define(["ol"],t):"object"==typeof exports?exports.ol3RotateFeature=t(require("ol")):e.ol3RotateFeature=t(e.ol)}(this,function(e){return function(e){function t(o){if(r[o])return r[o].exports;var n=r[o]={exports:{},id:o,loaded:!1};return e[o].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="/dist/",t(0)}([function(e,t,r){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(t,"__esModule",{value:!0}),t.RotateFeatureEventType=t.RotateFeatureEvent=t.RotateFeatureInteraction=void 0;var n=r(3),a=o(n),u=r(1);t.RotateFeatureInteraction=a["default"],t.RotateFeatureEvent=u.RotateFeatureEvent,t.RotateFeatureEventType=u.RotateFeatureEventType},function(e,t,r){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.RotateFeatureEvent=t.RotateFeatureEventType=void 0;var i=r(2),s=o(i);t.RotateFeatureEventType={START:"rotatefeaturestart",ROTATING:"rotating",END:"rotatefeatureend"},t.RotateFeatureEvent=function(e){function t(e,r){n(this,t);var o=a(this,Object.getPrototypeOf(t).call(this,e));return o.features=r,o}return u(t,e),t}(s["default"])},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),n=function(){function e(t,o){r(this,e),this.propagationStopped=void 0,this.type=t,this.target=o||null}return o(e,[{key:"preventDefault",value:function(){this.propagationStopped=!0}},{key:"stopPropagation",value:function(){this.propagationStopped=!0}}]),e}();n.stopPropagation=function(e){e.stopPropagation()},n.preventDefault=function(e){e.preventDefault()},t["default"]=n},function(e,t,r){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e){var t=e.map.forEachFeatureAtPixel(e.pixel,function(e){return e});return!t||this.lastCoordinate_||!this.features_.getArray().includes(t)&&t!==this.arrowFeature_?t&&t===this.anchorFeature_?(this.anchorMoving_=!0,f.call(this,e),!0):!1:(this.lastCoordinate_=e.coordinate,f.call(this,e),this.dispatchEvent(new g.RotateFeatureEvent(g.RotateFeatureEventType.START,this.features_)),!0)}function l(e){return this.lastCoordinate_?(this.lastCoordinate_=void 0,f.call(this,e),this.dispatchEvent(new g.RotateFeatureEvent(g.RotateFeatureEventType.END,this.features_)),!0):this.anchorMoving_?(this.anchorMoving_=!1,f.call(this,e),!0):!1}function c(e){var t=this,r=e.coordinate,o=this.anchorFeature_.getGeometry().getCoordinates(),n=function(e,r){return e.set(t.angleProperty_,(e.get(t.angleProperty_)||0)+r)};if(this.lastCoordinate_)!function(){var a=[t.lastCoordinate_[0]-o[0],t.lastCoordinate_[1]-o[1]],u=[r[0]-o[0],r[1]-o[1]],i=Math.atan2(a[0]*u[1]-u[0]*a[1],a[0]*u[0]+a[1]*u[1]);t.features_.forEach(function(e){e.getGeometry().rotate(i,o),n(e,i)}),[t.anchorFeature_,t.arrowFeature_].forEach(function(e){return n(e,i)}),t.dispatchEvent(new g.RotateFeatureEvent(g.RotateFeatureEventType.ROTATING,t.features_)),t.lastCoordinate_=e.coordinate}();else if(this.anchorMoving_){var a=r[0]-o[0],u=r[1]-o[1];this.anchorFeature_.getGeometry().translate(a,u),this.arrowFeature_.getGeometry().translate(a,u)}}function f(e){var t=e.map.getTargetElement(),r=e.map.forEachFeatureAtPixel(e.pixel,function(e){return e}),o=function(e){var r=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];r&&(t.style.cursor="-webkit-"+e,t.style.cursor="-moz-"+e),t.style.cursor=e};this.lastCoordinate_?(this.previousCursor_=t.style.cursor,o("grabbing",!0)):r&&(this.features_.getArray().includes(r)||r===this.arrowFeature_)?(this.previousCursor_=t.style.cursor,o("grab",!0)):r&&r===this.anchorFeature_||this.anchorMoving_?(this.previousCursor_=t.style.cursor,o("crosshair")):(o(this.previousCursor_||""),this.previousCursor_=void 0)}function d(e){var t,r=[255,255,255,.8],o=[0,153,255,.8],a=[255,255,255,.01],u=2,i=(t={},n(t,F,[new v["default"].style.Style({image:new v["default"].style.RegularShape({fill:new v["default"].style.Fill({color:[0,153,255,.8]}),stroke:new v["default"].style.Stroke({color:o,width:1}),radius:4,points:6}),zIndex:1/0})]),n(t,w,[new v["default"].style.Style({fill:new v["default"].style.Fill({color:a}),stroke:new v["default"].style.Stroke({color:r,width:u+2}),text:new v["default"].style.Text({font:"12px sans-serif",offsetX:20,offsetY:-20,fill:new v["default"].style.Fill({color:"blue"}),stroke:new v["default"].style.Stroke({color:r,width:u+1})}),zIndex:1/0}),new v["default"].style.Style({fill:new v["default"].style.Fill({color:a}),stroke:new v["default"].style.Stroke({color:o,width:u}),zIndex:1/0})]),t);return function(t,r){var o,n=t.get(e)||0;switch(!0){case t.get(F):return o=i[F],o[0].getImage().setRotation(-n),o;case t.get(w):o=i[w];var a=t.getGeometry().getCoordinates(),u=new v["default"].geom.Polygon([[[a[0],a[1]-6*r],[a[0]+8*r,a[1]-12*r],[a[0],a[1]+30*r],[a[0]-8*r,a[1]-12*r],[a[0],a[1]-6*r]]]);return u.rotate(n,a),o[0].setGeometry(u),o[1].setGeometry(u),o[0].getText().setText(Math.round(180*-n/Math.PI)+"Â°"),o}}}Object.defineProperty(t,"__esModule",{value:!0});var h=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),p=function E(e,t,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(void 0===o){var n=Object.getPrototypeOf(e);return null===n?void 0:E(n,t,r)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(r)},y=r(5),v=o(y),_=r(4),g=r(1),F="anchor",w="arrow",b="ghost",m=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];a(this,t);var r=u(this,Object.getPrototypeOf(t).call(this,{handleEvent:t.handleEvent,handleDownEvent:s,handleUpEvent:l,handleDragEvent:c,handleMoveEvent:f}));return r.features_=e.features,(0,_.assertInstanceOf)(r.features_,v["default"].Collection),r.angleProperty_=e.angleProperty||"angle",r.overlay_=new v["default"].layer.Vector({style:e.style||d.call(r,r.angleProperty_),source:new v["default"].source.Vector({features:new v["default"].Collection})}),r.previousCursor_=void 0,r.ghostFeature_=void 0,r.anchorFeature_=void 0,r.arrowFeature_=void 0,r.lastCoordinate_=void 0,r.anchorMoving_=!1,r.features_.on("add",r.handleFeatureAdd_,r),r.features_.on("remove",r.handleFeatureRemove_,r),r}return i(t,e),h(t,[{key:"setMap",value:function(e){this.overlay_.setMap(e),p(Object.getPrototypeOf(t.prototype),"setMap",this).call(this,e),this.updateInteractionFeatures_()}},{key:"updateInteractionFeatures_",value:function(){var e=this.features_.getArray().map(function(e){return e.getGeometry()});if(0===e.length)return void this.reset_();var t=new v["default"].geom.GeometryCollection(e).getExtent(),r=v["default"].extent.getCenter(t);this.createOrUpdateAnchorFeature_(r),this.createOrUpdateArrowFeature_(r)}},{key:"reset_",value:function(){var e=this;[this.anchorFeature_,this.arrowFeature_].forEach(function(t){t&&e.overlay_.getSource().removeFeature(t)}),this.anchorFeature_=this.arrowFeature_=this.lastCoordinate_=void 0,this.anchorMoving_=!1}},{key:"createOrUpdateAnchorFeature_",value:function(e){this.anchorFeature_?this.anchorFeature_.getGeometry().setCoordinates(e):(this.anchorFeature_=new v["default"].Feature(n({geometry:new v["default"].geom.Point(e)},F,!0)),this.overlay_.getSource().addFeature(this.anchorFeature_))}},{key:"createOrUpdateGhostFeature_",value:function(e){this.ghostFeature_?this.ghostFeature_.getGeometry().setGeometries(e):(this.ghostFeature_=new v["default"].Feature(n({geometry:new v["default"].geom.GeometryCollection(e)},b,!0)),this.overlay_.getSource().addFeature(this.ghostFeature_))}},{key:"createOrUpdateArrowFeature_",value:function(e){this.arrowFeature_?this.arrowFeature_.getGeometry().setCoordinates(e):(this.arrowFeature_=new v["default"].Feature(n({geometry:new v["default"].geom.Point(e)},w,!0)),this.overlay_.getSource().addFeature(this.arrowFeature_))}},{key:"handleFeatureAdd_",value:function(e){var t=e.element;(0,_.assertInstanceOf)(t,v["default"].Feature),this.updateInteractionFeatures_()}},{key:"handleFeatureRemove_",value:function(e){var t=e.element;(0,_.assertInstanceOf)(t,v["default"].Feature),this.updateInteractionFeatures_()}}]),t}(v["default"].interaction.Pointer);t["default"]=m,m.handleEvent=function(e){return v["default"].interaction.Pointer.handleEvent.call(this,e)}},function(e,t){"use strict";function r(e){var t=arguments.length<=1||void 0===arguments[1]?"":arguments[1];if(t=["Assertion failed",t].join(": "),!e)throw new Error(t)}function o(e,t){r(e instanceof t,"Expected instanceof "+u(t)+" but got "+u(e)+".")}function n(){}function a(e){return e}function u(e){return e instanceof Function?e.name||"unknown type name":e instanceof Object?e.constructor.name||Object.prototype.toString.call(e):null===e?"null":"undefined"==typeof e?"undefined":i(e)}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};t.assert=r,t.assertInstanceOf=o,t.noop=n,t.identity=a,t.getValueType=u},function(t,r){t.exports=e}])});